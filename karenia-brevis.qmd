---
title: "ESS330-results-discussion"
authors:
  - name: Megan Hoover
    affiliation: Colorado State University
    roles: [writing]
    corresponding: true
  - name: Lilly Zapalac
    affiliation: Colorado State University
    roles: [writing]
  - name: Tessa
    affiliation: Colorado State University
    roles: [writing]
    
format: 
  html:
    self-contained: true
    
knitr:
  opts_chunk: 
    echo: true
    collapse: true
    comment: "#>"
    
bibliography: references.bib
csl: apa.csl
---


## Karenia Brevis Harmful Algal Blooms



# Abstract

Harmful red tide events along the Florida coast have been occurring more frequently and are lasting for longer periods of time than they used to. Karenia Brevis is commonly known as the red tide and is a type of algae that is fed by various organic nutrients that occur in upwelling zones, optimal water conditions, and are very complex to predict. Here, we try to understand what conditions allow Karenia brevis to thrive and what may be causing the increased outbreaks. Using an observation dataset from Florida Fish and Wildlife Conservation, we looked at correlations between salinity (ppt), water temperature (°C), and cell counts (per L) using the linear regression model and GAM. Our graphs show that salinity and water temperature have a significant role in higher cell counts, the algae cells are higher in a salinity of 30-35 and a temperature of 22-30 °C.  Our model statistics revealed that predicting Karenia Brevis with just salinity and water temperature is not enough to make future predictions; other variables, such as nutrients, need to be accounted for. Cell counts have been increasing since the beginning of our dataset in 1954 and understanding why can help to make needed changes to decrease the amount of red tide events along the coast.  



# Introduction



# Data Overview 

The data we used to better understand the red tide causing blooms, was provided by NOAA [see @ noaa_2014]. The .csv file covered sites in Florida, Texas, and Alabama. All of the sites we used for this study were from Pinellas County, Fl to Lee County, Fl or from latitude and longitudes of 26.25’49 N, –82.08’50 W and 27.54’16 N, –82.51’40 W. We chose this region due to a higher number of recorded blooms in comparison to other areas. The list of variables in the data set were location columns that detailed the name of the water body that the Karenia Brevis algal are found and which city they’re found off. There’s also a column for latitude, longitude, date, time of the extraction, depth of water measures, ranking of algal cells per liter, salinity of the water in parts per trillion, water temperature measured in degrees Celsius, and the object id where the sites are being tested at. Even though there’s a lot of variables, there’s a lot of missing data for some salinity and water temperature.


# Methods

First we looked at the data and cleaned it to be usable. We read in the data to R Studio and then created a new data frame by filtering sites from latitude and longitudes of 26.25’49 N, –82.08’50 W and 27.54’16 N, –82.51’40 W. We selected relevant columns of STATE_ID, DESCRIPTION, LATITUDE, LONGITUDE, SAMPLE_DATE, SAMPLE_DEPTH,CELLCOUNT, SALINITY, and WATER_TEMP. To make the sure the data made sense, we removed NA values from the whole data frame. The data set had many observations where there wasn't cell counts observed, because we wanted to view the relationship between the sites that had high counts, we filtered the cell count column to only show rows where the count was greater than 0. 

After cleaning the data we tested relationships using vis_cor, scatter plots,and GAM and Random Forest models. Using Vis_cor we made a visual pixel graph to show if there was any correlation between the variables. We created several scatter plots to see if there were any relationships between water temperature, salinity, and cell count, and the date. The relationships in the graph were non-linear, but showed trends from dates listed in the data. We tested the data on a GAM model to see how good it was at predicting the future cell counts. The GAM model used the day of the year (to check a seasonal trend), and cell count by interaction between salinity and water temp to predict future trends. A Random Forest model was also tested to predict cell count from the salinity, water temperature, and day of the year.


Load Libraries:
```{r}
#setup, include=FALSE
knitr::opts_chunk$set(echo = TRUE)
library(broom)
library(visdat)
library(tidyr)
library(tidyverse)
library(tidymodels)
library(lubridate)
library(outliers)
library(patchwork)
library(mgcv)
library(tibble)
library(randomForest)
```

Load data:
```{r}
karenia_brevis<-read_csv("C:/Users/samho/Desktop/ESS330/github/ESS330-results-discussion/habsos_20220225.csv")


#filter data to only include between 
# Filter the data frame directly in one step
filtered_karenia <- karenia_brevis%>%
  filter(LATITUDE >= 26.25 & LATITUDE<= 27.9044 & 
         LONGITUDE >= -82.8600 & LONGITUDE <= -82.1472)

#select columns we want
filtered_karenia <- filtered_karenia %>%
  select(
    STATE_ID,
    DESCRIPTION,
    LATITUDE,
    LONGITUDE,
    SAMPLE_DATE,
    SAMPLE_DEPTH,
    CELLCOUNT,
    SALINITY,
    WATER_TEMP,
  )


#show structure of dataset and na
vis<-vis_dat(filtered_karenia)
print(vis)

#change data frame to tibble
filtered_karenia <- as_tibble(filtered_karenia)

#library(lubridate)
#change the date format, currently character


#change the data format from charachter to date and manually change the 2 digit year to interpret correctly
filtered_karenia <- filtered_karenia %>%
  mutate(SAMPLE_DATE = parse_date_time(SAMPLE_DATE, orders = "d-b-y I.M.S p"),
         SAMPLE_DATE = if_else(year(SAMPLE_DATE) > 2024, SAMPLE_DATE %m-% years(100), SAMPLE_DATE))

#format date from character to date
filtered_karenia <- filtered_karenia %>%
  mutate(SAMPLE_DATE = as.Date(SAMPLE_DATE, format = "%d-%m-%Y"))

#remove na values
filtered_karenia <- filtered_karenia %>%
  drop_na()

#check correlation
filtered_karenia %>%
  select(where(is.numeric)) %>%
  vis_cor()

#filter to only show rows with cells greater >0
filtered_karenia1 <- filtered_karenia %>%
  filter(CELLCOUNT > 0)

#now format date from character to actual date
filtered_karenia1 <- filtered_karenia %>%
  mutate(SAMPLE_DATE = as.Date(SAMPLE_DATE, format = "%d-%m-%Y"))


#check correlation. Doesn't show any strong relationships, curious. It's because it assumes a linear relationship. Multiple complex interactions
filtered_karenia1 %>%
  select(where(is.numeric)) %>%
  vis_cor()


```


Data Visualizations:
```{r}

#scatter plot of the cell counts and salinity with dates shown
plot<- filtered_karenia %>%
  ggplot(aes(x = SALINITY, y = CELLCOUNT, color= SAMPLE_DATE, alpha= .05)) +
  geom_point() +
  labs(title = "Salinity And Redtide Cell Counts Over Time",
subtitle = "Cell count measured in cells/L, salinity measured in part per thousand/L")


print(plot)

ggsave("salinity-cellcount.png", plot = plot, width = 6, height = 4, dpi = 300)


#scatter plot of the cell counts and salinity. Shows relationship!
 salinity_cellcount2<- filtered_karenia1 %>%
  ggplot(aes(x = SALINITY, y = CELLCOUNT, color= , alpha= .05)) +
  geom_point() +
   labs(title = "Salinity And Redtide Cell Counts",
subtitle = "Cell count measured in cells/L, salinity measured in part per thousand/L") 
 
 ggsave("salinity-cellcount2.png", plot = salinity_cellcount2, width = 6, height = 4, dpi = 300)
 
 print(salinity_cellcount2)
 
 #graph of water temp and cell count relationship. There's one!
watertemp_cellcount<- filtered_karenia1 %>%
ggplot(aes(x = WATER_TEMP, y = CELLCOUNT, color= CELLCOUNT)) +
 geom_point() +
labs(title = "Water Temperatures Affects of Redtide Cell Counts",
subtitle = "Cell count measured in cells/L, water temperature measured in celsius")

ggsave("temp_cell.png", plot = watertemp_cellcount, width = 6, height = 4, dpi = 300)

print(watertemp_cellcount)

#cell count and date
date_cellcount <-filtered_karenia1 %>%
  ggplot(aes(x = SAMPLE_DATE, y = CELLCOUNT, color= , alpha= .05)) +
  geom_point() +
  labs(title = "Yearly Affects of Redtide Cell Counts From 1954-2021",
subtitle = "Cell count measured in cells/L")


ggsave("date_cell.png", plot = date_cellcount, width = 6, height = 4, dpi = 300)

print(date_cellcount)
 

salinity_temp<- filtered_karenia1 %>%
  ggplot(aes(x = SALINITY, y = WATER_TEMP, color= CELLCOUNT , alpha= .02)) +
  geom_point() +
   labs(title = "Salinity & Water Temperature Conditions For Red Tide",
subtitle = "Water temperature in C, salinity in parts per thousand/L") 
 
ggsave("salinity_temp.png", plot = salinity_temp, width = 6, height = 4, dpi = 300)

print(salinity_temp)
```



Statistical Test: GAM Model
```{r}

#Convert SAMPLE_DATE to numeric day of year (1–365) for seasonal trend
filtered_karenia_days <- filtered_karenia1 %>%
  mutate(DAY_OF_YEAR = yday(SAMPLE_DATE))

#Fit the GAM model using DAY_OF_YEAR with bs = "cc":
#Fit GAM with interaction between salinity and water temp
gam_model <- gam(CELLCOUNT ~ 
                   te(SALINITY, WATER_TEMP) +  # interaction term
                   s(DAY_OF_YEAR, bs = "cc"),  # cyclic seasonal effect
                 family = quasipoisson(link = "log"),  # use for overdispersed count data
                 data = filtered_karenia_days,
                 method = "REML")

# Fit a GAM model with non-linear smooths for SALINITY and WATER_TEMP
# and a time effect to account for seasonal or time-based trends
summary(gam_model)

filtered_karenia2<- filtered_karenia1 %>%
  mutate(SAMPLE_DATE = dmy_hms(SAMPLE_DATE),  # adjust to your format if needed
         DAY_OF_YEAR = yday(SAMPLE_DATE))

# 2. Fit GAM with interaction between salinity and water temp
gam_model <- gam(CELLCOUNT ~ 
                   te(SALINITY, WATER_TEMP) +  # interaction term
                   s(DAY_OF_YEAR, bs = "cc"),  # cyclic seasonal effect
                 family = quasipoisson(link = "log"),  # use for overdispersed count data
                 data = filtered_karenia_days,
                 method = "REML")

summary(gam_model)
plot(gam_model)

ggsave("gam_model.png", plot = gam, width = 6, height = 4, dpi = 300)
```
Statistical test: Random Forest
```{r}
#Now, let's fit the Random Forest model to predict CELLCOUNT from the other variables.
# Fit a random forest model to predict CELLCOUNT
rf_model <- randomForest(CELLCOUNT ~ SALINITY + WATER_TEMP + DAY_OF_YEAR, 
                         data = filtered_karenia_days, 
                         importance = TRUE, 
                         ntree = 500)  # ntree is the number of trees

# Print the model summary
print(rf_model)
```

# Results

The data visuals showing the relationship between water temperature and salinity to determine cell count are non-linear, and had some significance. The GAM model also confirms that with a p-value of < 2e-16 for both, indicating that the intercept is highly significant. The GAM model using day of the year to determine cell count was also significant with a p-value of less than .05. Although these all turned out to be significant in determining cell count, the r^2 value indicated that the model only explained 0.74% of the variance in cell count, adjusted for the number of predictors. This is quite low, meaning other factors not included in the model may influence cell count significantly. The model was only able to explain about 9% of the variability in cell count. Again, this is relatively low, suggesting a lot of unexplained variation. The Random forest model was an even worst fit, with only .25% of the variation explained, using salinity, water temperature, and day of the year as predictors. Both models weren't a good fit to use a predictions, there wasn't enough data variables to accurately describe the complexity of the Karenia Brevis blooms.

Based on the data visuals from our filtered data, we can see there is a trend 

using the Gam Model- This means you're modeling CELLCOUNT using:

te(SALINITY, WATER_TEMP): A tensor product smooth that models the interaction between salinity and water temperature.

s(DAY_OF_YEAR, bs = "cc"): A cyclical smooth for the day of the year, capturing seasonality (since day 1 and day 365 are close to each other in time).

Parametric Coefficients:
(Intercept): The baseline level of CELLCOUNT when all predictor variables are at their reference values (e.g., average).

Estimate: 12.69 (the intercept for the model).

p-value: < 2e-16, indicating that the intercept is highly significant.

Smooth Terms:
te(SALINITY, WATER_TEMP): The interaction between salinity and water temperature.

edf (Effective Degrees of Freedom) = 16.048: Indicates the complexity of the smooth term. Higher values suggest a more complex relationship.

F-statistic = 4.481: The test statistic for significance. A larger F-value suggests a more significant interaction between salinity and water temperature.

p-value = < 2e-16: This very small p-value indicates that the interaction between salinity and water temperature is highly significant.

s(DAY_OF_YEAR): The smooth term for day of the year.

edf = 7.736: The smooth term for day of year also has a moderately complex relationship, reflecting seasonal trends.

F-statistic = 6.900: Indicates a strong relationship between day of year and cell count.

p-value = < 2e-16: Again, the day of year has a highly significant effect on cell count.

Model Fit:
R-sq.(adj) = 0.00742: This indicates that the model explains 0.74% of the variance in cell count, adjusted for the number of predictors. This is quite low, meaning other factors not included in the model may influence cell count significantly.

Deviance explained = 8.96%: This metric is similar to R-squared but for models with a Poisson-like distribution (in this case, a quasipoisson). It means that the model explains about 9% of the variability in cell count. Again, this is relatively low, suggesting a lot of unexplained variation.

Conclusion:
The interaction between salinity and water temperature and the seasonality captured by day of year are both significant predictors of cell count.

However, the model fit is weak: the low R-squared and deviance explained values suggest there are other unaccounted factors that drive cell count.

The small p-values for both the interaction and day of year suggest that these factors are important predictors, but more data or additional predictors (like nutrients, precipitation, or wind) could improve the model.

 Consider adding other environmental variables (e.g., nutrients, wind speed), or another model like random forest, which can capture more complex relationships.

